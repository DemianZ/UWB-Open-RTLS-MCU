# Система локального позиционирования

**Описание взаимодействия сервера и базовых станций**

Разработал: Д.С. Зенков



## 1 Введение

### 1.1  Термины и определения

- *RTLS –* система позиционирования объектов в режиме реального времени 
-  *Базовая станция (БС, «якорь»)* – устройство, которое взаимодействует с метками в процессе определения координат последних. Базовые станции имеют фиксированные координаты, относительно которых определяются координаты меток. Базовые станции располагаются так, чтобы в любой точке контролируемой территории метка могла «видеть» минимум три базовые станции.
-  *Метка* — радиоэлектронное устройство, которые прикрепляются к контролируемым объектам и взаимодействуют с RTLS.
- *Серверное программное обеспечение* — программное обеспечение, обеспечивающее управление процессом измерений, расчет координат объектов, обработку и накопление данных. 

### 1.2  Назначение документа

Документ определяет состав команд и их формат. Протокол описанный в данном документе позволяет конфигурировать устройства системы позиционирования, а также получать локационные данные от БС.



## 2 Формат и перечень сообщений

Данные, между датчиком и внешним устройством передаются в виде сообщений стандартного формата (Таблица 2.1). Сообщение передаётся байтами 

Таблица 2.1

| Порядковый номер поля |   Название поля   |    Размер поля, байт     | Описание                                                     |
| --------------------- | :---------------: | :----------------------: | ------------------------------------------------------------ |
| 1                     |      Префикс      |            1             | Поле является маркером начала сообщения.   Входящие от сервера сообщения от должны иметь префикс 94h, а   исходящие сообщения от БС должны выдаваться программой с префиксом 9Dh. |
| 2                     |   Сетевой адрес   |            1             | Поле содержит:   - для префикса 94h сетевой адрес получателя сообщения;   - для префикса 9Dh сетевой адрес отправителя сообщения.   Адрес со значением 255 считается широкополосным. |
| 3                     |   Код операции    |            1             | Поле содержит:   - для префикса 94h код операции, которую должна выполнить БС;   - для префикса 9Dh код операции, на которую выдаётся ответ. |
| 4                     |      Данные       | Зависит от кода операции | Состав данных и формат поля зависит от кода операции.        |
| 5                     | Контрольная сумма |            1             | Поле используется для контроля целостности данных.   Алгоритм вычисления описан в разделе 5. |



Перечень сообщений приведён в таблице 2.2.

Таблица 2.2

| **№** | **Код операции** | **Описание операции**                            |
| ----- | ---------------- | ------------------------------------------------ |
| 1     | 06h              | Считать сетевые настройки                        |
| 2     | 07h              | Записать сетевые   настройки                     |
| 3     | 08h              | Считать настройки   радиомодуля                  |
| 4     | 09h              | Записать настройки   радиомодуля                 |
| 5     | 0Ah              | Считать настройки якоря                          |
| 6     | 0Bh              | Установить настройки   якоря                     |
| 5     | 0Сh              | Считать настройки метки                          |
| 7     | 0Dh              | Установить настройки   метки                     |
| 9     | 0Eh              | Считать локационные   данные (формат автовыдачи) |

 

 






## 3     Описание команд

### 4.1  Считать сетевые настройки (06h)

Команда предназначена для чтения следующих сетевых настроек: 

| №    | Настройка           | Значение   по умолчанию |
| ---- | ------------------- | ----------------------- |
| 1    | IP-адрес устройства | 192.168.1.50            |
| 2    | Маска   подсети     | 255.255.255.0           |
| 3    | IP-адрес сервера    | 192.168.1.10            |
| 4    | Порт   сервера      | 3000                    |

После получения команды БС отправляет ответ с текущими настройками.

*Формат команды от сервера*

| Смещение, байт | Размер поля,   байт | Значение | Описание                    |
| -------------- | ------------------- | -------- | --------------------------- |
| 0              | 1                   | 94h      | Префикс                     |
| +1             | 1                   | 00h…FFh  | Сетевой адрес   получателя. |
| +2             | 1                   | 06h      | Код операции.               |
| +3             | 1                   | 00h…FFh  | Контрольная   сумма.        |

 

*Формат ответа устройства*

| Смещение, байт | Размер поля,   байт | Значение         | Описание                         |
| -------------- | ------------------- | ---------------- | -------------------------------- |
| 0              | 1                   | 9Dh              | Префикс                          |
| +1             | 1                   | 00h…FFh          | Сетевой адрес   получателя.      |
| +2             | 1                   | 06h              | Код операции.                    |
| +3             | 4                   | [b0-b3]: 00h…FFh | IP-адрес устройства: b0.b1.b2.b3 |
| +7             | 4                   | [b0-b3]: 00h…FFh | Маска подсети: b0.b1.b2.b3       |
| +11            | 4                   | [b0-b3]: 00h…FFh | IP-адрес сервера: b0.b1.b2.b3    |
| +15            | 2                   | 0000h…FFFFh      | Порт сервера                     |
| +17            | 1                   | 00h…FFh          | Контрольная сумма.               |

  

### 4.2  Записать сетевые настройки (07h)

Команда предназначена для установки следующих сетевых настроек: IP-адрес устройства, маска подсети, ip-адрес и порт сервера. После получения команды БС отправляет сообщение об успешной обработке команды, перенастривает сетевые параметры и производит перезагрузку сетевых служб. 

*Формат команды от сервера*

| Смещение, байт | Размер поля,   байт | Значение         | Описание                         |
| -------------- | ------------------- | ---------------- | -------------------------------- |
| 0              | 1                   | 94h              | Префикс                          |
| +1             | 1                   | 00h…FFh          | Сетевой адрес   получателя.      |
| +2             | 1                   | 07h              | Код операции.                    |
| +3             | 4                   | [b0-b3]: 00h…FFh | IP-адрес устройства: b0.b1.b2.b3 |
| +7             | 4                   | [b0-b3]: 00h…FFh | Маска подсети: b0.b1.b2.b3       |
| +11            | 4                   | [b0-b3]: 00h…FFh | IP-адрес сервера: b0.b1.b2.b3    |
| +15            | 2                   | 0000h…FFFFh      | Порт сервера                     |
| +17            | 1                   | 00h…FFh          | Контрольная сумма.               |

 

*Формат ответа устройства*

| Смещение, байт | Размер поля,   байт             | Значение | Описание                    |
| -------------- | ------------------------------- | -------- | --------------------------- |
| 0              | 1                               | 9Dh      | Префикс                     |
| +1             | 1                               | 00h…FFh  | Сетевой адрес   получателя. |
| +2             | 1                               | 07h      | Код операции.               |
| +3             | 1                               | 00h      | Команда выполнена успешно   |
| 01h            | Команда не может быть выполнена |          |                             |
| +4             | 1                               | 00h…FFh  | Контрольная сумма.          |

 

 






### 4.3  Считать настройки радиомодуля (08h)

Команда предназначена для чтения следующих настроек радиомодуля: 

| №    | Настройка                        | Значение   по умолчанию |
| ---- | -------------------------------- | ----------------------- |
| 1    | Сhannel number                   |                         |
| 2    | Pulse Repetition Frequency       |                         |
| 3    | TX Preamble Length               |                         |
| 4    | rxPAC (Acquisition   Chunk Size) |                         |
| 5    | TX Preamble Code                 |                         |
| 6    | RX Preamble Code                 |                         |
| 7    | Non-std SFD                      |                         |
| 8    | Data Rate                        |                         |
| 9    | PHT Mode                         |                         |
| 10   | SFD Timeout Value                |                         |

После получения команды БС отправляет ответ с текущими настройками.

*Формат команды от сервера*

| Смещение, байт | Размер поля,   байт | Значение | Описание                    |
| -------------- | ------------------- | -------- | --------------------------- |
| 0              | 1                   | 94h      | Префикс                     |
| +1             | 1                   | 00h…FFh  | Сетевой адрес   получателя. |
| +2             | 1                   | 08h      | Код операции.               |
| +3             | 1                   | 00h…FFh  | Контрольная   сумма.        |

 

*Формат ответа устройства*

| Смещение, байт | Размер поля, байт | Значение | Описание                       |
| -------------- | ----------------- | -------- | ------------------------------ |
| 0              | 1                 | 9Dh      | Префикс                        |
| +1             | 1                 | 00h…FFh  | Сетевой адрес получателя.      |
| +2             | 1                 | 06h      | Код операции.                  |
| +3             | 1                 |          | Сhannel number                 |
| +4             | 1                 |          | Pulse Repetition Frequency     |
| +5             | 1                 |          | TX Preamble Length             |
| +6             | 1                 |          | rxPAC (Acquisition Chunk Size) |
| +7             | 1                 |          | TX Preamble Code               |
| +8             | 1                 |          | RX Preamble Code               |
| +9             | 1                 |          | Non-std SFD                    |
| +10            | 1                 |          | Data Rate                      |
| +11            | 1                 |          | PHT Mode                       |
| +13            | 1                 |          | SFD Timeout Value              |
| +14            | 1                 | 00h…FFh  | Контрольная сумма.             |



### 4.4  Записать настройки радиомодуля (09h)

### 4.5  Считать настройки якоря (0Ah)

### 4.6  Установить настройки якоря (0Bh)

### 4.7  Считать настройки метки

### 4.8  Установить настройки метки 

### 4.9  Считать локационные данные (формат автовыдачи данных) (0Dh)

Команда используется БС для выдачи данных на сервер. В случае, если период выдачи не равен нулю, данные выдаются автоматически, без запроса от сервера.

*Формат выдачи данных от БС*

| Смещение, байт | Размер поля,   байт | Значение    | Описание                    |
| -------------- | ------------------- | ----------- | --------------------------- |
| 0              | 1                   | 9Dh         | Префикс                     |
| +1             | 1                   | 00h…FFh     | Сетевой адрес   получателя. |
| +2             | 1                   | 0Сh         | Код операции.               |
| +3             | 2                   | 0000h…FFFFh | Идентификатор   метки.      |
| +5             | 4                   |             | Временная метка             |
| +9             | 1                   | 00h…FFh     | Контрольная сумма.          |

  

## 5 Алгоритм вычисления контрольной суммы

#### CRC08

```c
#define CRC8_POLY 0x8B

U08 CRC_08 (U08 init, U08* pBuf,   U16 len) {
  U08 crc = init;
	while (len—) {
    crc = crc ^ *pBuf++;
		for (U08 i=0; i < 8; i++)
      crc = (crc & 0x80) ? ((crc   << 1) ^ CRC8_POLY) : (crc << 1);
  }
  return crc;
}   
```

#### CRC16

```c
#define CRC16_POLY 0x1021      

U16 CRC_16 (U16 init, U08* pBuf, U16 len) {
  U16 crc = init;
  while (len--) {
    crc ^= *pBuf++ << 8;
    for (U08 index = 0; index   < 8; index++)
      crc = crc & 0x8000 ? (crc << 1) ^ CRC16_POLY : crc << 1;
  }
  return crc;
}        
```